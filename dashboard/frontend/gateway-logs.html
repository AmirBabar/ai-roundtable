<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gateway Logs - Council Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Gateway Logs specific styles */
        .log-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .log-filter-btn {
            padding: 6px 12px;
            border: 1px solid #444;
            background: #1a1a2e;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .log-filter-btn:hover {
            background: #2a2a4e;
        }

        .log-filter-btn.active {
            background: #4a4a8e;
            color: white;
        }

        .log-filter-btn[data-level="ERROR"].active {
            background: #8b2020;
        }

        .log-filter-btn[data-level="WARNING"].active {
            background: #8b6a20;
        }

        .log-filter-btn[data-level="INFO"].active {
            background: #208b40;
        }

        .log-search {
            flex: 1;
            min-width: 200px;
            padding: 6px 10px;
            border: 1px solid #444;
            background: #1a1a2e;
            color: #eee;
            border-radius: 4px;
        }

        .log-container {
            background: #0d0d1a;
            border: 1px solid #333;
            border-radius: 8px;
            height: 500px;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .log-container.auto-scroll {
            scroll-behavior: smooth;
        }

        .log-entry {
            padding: 4px 8px;
            border-bottom: 1px solid #1a1a2e;
            display: flex;
            gap: 10px;
            transition: background 0.1s;
        }

        .log-entry:hover {
            background: #15152e;
        }

        .log-entry.ERROR {
            background: rgba(139, 32, 32, 0.2);
            border-left: 3px solid #c04040;
        }

        .log-entry.WARNING {
            background: rgba(139, 106, 32, 0.15);
            border-left: 3px solid #c0a040;
        }

        .log-entry.INFO {
            border-left: 3px solid #40c060;
        }

        .log-timestamp {
            color: #666;
            min-width: 140px;
            flex-shrink: 0;
        }

        .log-level {
            min-width: 60px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .log-level.ERROR { color: #ff6060; }
        .log-level.WARNING { color: #ffc060; }
        .log-level.INFO { color: #60c080; }
        .log-level.DEBUG { color: #60a0ff; }

        .log-message {
            flex: 1;
            word-break: break-word;
            color: #ddd;
        }

        .log-status-code {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }

        .log-status-code.error {
            background: #8b2020;
            color: #ff9090;
        }

        .log-status-code.success {
            background: #208b40;
            color: #90ff90;
        }

        .log-model {
            color: #8090ff;
            font-weight: 500;
        }

        .log-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #1a1a2e;
            border-radius: 8px;
        }

        .log-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .log-stat-label {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
        }

        .log-stat-value {
            font-weight: bold;
            font-size: 16px;
        }

        .log-stat-value.ERROR { color: #ff6060; }
        .log-stat-value.WARNING { color: #ffc060; }
        .log-stat-value.INFO { color: #60c080; }

        .connection-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .connection-indicator.connected {
            background: rgba(32, 139, 64, 0.3);
            color: #60c080;
        }

        .connection-indicator.disconnected {
            background: rgba(139, 32, 32, 0.3);
            color: #c04040;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .connection-indicator.connected .connection-dot {
            background: #40ff60;
            animation: pulse 1.5s infinite;
        }

        .connection-indicator.disconnected .connection-dot {
            background: #ff4040;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            gap: 10px;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header">
            <h1>Gateway Logs</h1>
            <div class="header-actions">
                <a href="index.html" style="text-decoration: none;">
                    <button class="log-filter-btn">Dashboard</button>
                </a>
                <a href="pricing.html" style="text-decoration: none;">
                    <button class="log-filter-btn">Pricing</button>
                </a>
                <div id="connectionStatus" class="connection-indicator disconnected">
                    <span class="connection-dot"></span>
                    <span>Disconnected</span>
                </div>
            </div>
        </header>

        <!-- Log Statistics -->
        <div class="log-stats" id="logStats">
            <div class="log-stat">
                <span class="log-stat-label">Errors</span>
                <span class="log-stat-value ERROR" id="errorCount">-</span>
            </div>
            <div class="log-stat">
                <span class="log-stat-label">Warnings</span>
                <span class="log-stat-value WARNING" id="warningCount">-</span>
            </div>
            <div class="log-stat">
                <span class="log-stat-label">Info</span>
                <span class="log-stat-value INFO" id="infoCount">-</span>
            </div>
            <div class="log-stat">
                <span class="log-stat-label">Last Error</span>
                <span class="log-stat-value" id="lastError">None</span>
            </div>
        </div>

        <!-- Log Controls -->
        <div class="log-controls">
            <button class="log-filter-btn active" data-level="">ALL</button>
            <button class="log-filter-btn" data-level="ERROR">ERROR</button>
            <button class="log-filter-btn" data-level="WARNING">WARNING</button>
            <button class="log-filter-btn" data-level="INFO">INFO</button>
            <button class="log-filter-btn" data-level="DEBUG">DEBUG</button>
            <input type="text" class="log-search" id="logSearch" placeholder="Search logs...">
            <button class="log-filter-btn" id="clearLogs">Clear</button>
            <button class="log-filter-btn" id="copyLogs">Copy</button>
            <label class="log-filter-btn" style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="autoScroll" checked>
                Auto-scroll
            </label>
        </div>

        <!-- Log Container -->
        <div class="log-container auto-scroll" id="logContainer">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>Waiting for gateway logs...</span>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        const AUTH_TOKEN = localStorage.getItem('dashboard-token') || '064dbe76-7476-4e1b-a31d-57f7b0e8d618';

        // State
        let eventSource = null;
        let currentFilter = '';
        let maxLogLines = 1000;
        let logEntries = [];

        // DOM Elements
        const logContainer = document.getElementById('logContainer');
        const logSearch = document.getElementById('logSearch');
        const autoScrollCheckbox = document.getElementById('autoScroll');
        const connectionStatus = document.getElementById('connectionStatus');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            fetchStats();
            fetchInitialLogs();
            startStreaming();
        });

        function setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('.log-filter-btn[data-level]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.log-filter-btn[data-level]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.level;
                    renderLogs();
                });
            });

            // Clear button
            document.getElementById('clearLogs').addEventListener('click', () => {
                logEntries = [];
                renderLogs();
            });

            // Copy button
            document.getElementById('copyLogs').addEventListener('click', () => {
                const text = logEntries.map(e => formatLogEntry(e)).join('\n');
                navigator.clipboard.writeText(text).then(() => {
                    const btn = document.getElementById('copyLogs');
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = originalText, 1500);
                });
            });

            // Search
            logSearch.addEventListener('input', renderLogs);

            // Auto-scroll pause on hover
            logContainer.addEventListener('mouseenter', () => {
                logContainer.classList.remove('auto-scroll');
            });

            logContainer.addEventListener('mouseleave', () => {
                if (autoScrollCheckbox.checked) {
                    logContainer.classList.add('auto-scroll');
                }
            });

            // Auto-scroll toggle
            autoScrollCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    logContainer.classList.add('auto-scroll');
                }
            });
        }

        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/api/gateway-logs/stats?token=${AUTH_TOKEN}`);
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('errorCount').textContent = stats.level_counts?.ERROR || 0;
                    document.getElementById('warningCount').textContent = stats.level_counts?.WARNING || 0;
                    document.getElementById('infoCount').textContent = stats.level_counts?.INFO || 0;
                    document.getElementById('lastError').textContent = stats.last_error || 'None';
                }
            } catch (error) {
                console.error('Failed to fetch stats:', error);
            }
        }

        async function fetchInitialLogs() {
            try {
                const response = await fetch(`${API_BASE}/api/gateway-logs?lines=100&token=${AUTH_TOKEN}`);
                if (response.ok) {
                    const data = await response.json();
                    logEntries = data.logs || [];
                    renderLogs();
                }
            } catch (error) {
                console.error('Failed to fetch logs:', error);
            }
        }

        function startStreaming() {
            const url = `${API_BASE}/api/gateway-logs?stream=true&token=${AUTH_TOKEN}`;
            eventSource = new EventSource(url);

            eventSource.onopen = () => {
                connectionStatus.className = 'connection-indicator connected';
                connectionStatus.querySelector('span:last-child').textContent = 'Live';
            };

            eventSource.onerror = () => {
                connectionStatus.className = 'connection-indicator disconnected';
                connectionStatus.querySelector('span:last-child').textContent = 'Disconnected';
                // Reconnect after 3 seconds
                setTimeout(startStreaming, 3000);
            };

            eventSource.addEventListener('log', (event) => {
                try {
                    const logEntry = JSON.parse(event.data);
                    addLogEntry(logEntry);
                } catch (error) {
                    console.error('Failed to parse log entry:', error);
                }
            });
        }

        function addLogEntry(entry) {
            logEntries.push(entry);

            // Trim to max lines
            if (logEntries.length > maxLogLines) {
                logEntries = logEntries.slice(-maxLogLines);
            }

            renderLogs();
            fetchStats(); // Update stats periodically
        }

        function renderLogs() {
            const searchTerm = logSearch.value.toLowerCase();

            // Filter logs
            let filteredLogs = logEntries;
            if (currentFilter) {
                filteredLogs = filteredLogs.filter(log => log._level === currentFilter);
            }
            if (searchTerm) {
                filteredLogs = filteredLogs.filter(log => {
                    const message = log.message || JSON.stringify(log);
                    return message.toLowerCase().includes(searchTerm);
                });
            }

            // Render
            if (filteredLogs.length === 0) {
                logContainer.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                        <span>${logEntries.length === 0 ? 'Waiting for gateway logs...' : 'No logs match the current filter.'}</span>
                    </div>
                `;
                return;
            }

            // Build HTML
            const html = filteredLogs.map(entry => {
                const timestamp = formatTimestamp(entry.timestamp || entry.time);
                const level = entry._level || 'INFO';
                const statusClass = entry.status_code >= 400 ? 'error' : 'success';
                const statusBadge = entry.status_code
                    ? `<span class="log-status-code ${statusClass}">${entry.status_code}</span>`
                    : '';
                const modelBadge = entry.model
                    ? `<span class="log-model">${entry.model}</span>`
                    : '';

                // Format message
                let message = entry.message || entry.error || JSON.stringify(entry);

                return `
                    <div class="log-entry ${level}">
                        <span class="log-timestamp">${timestamp}</span>
                        <span class="log-level ${level}">${level}</span>
                        ${statusBadge}
                        ${modelBadge}
                        <span class="log-message">${escapeHtml(message)}</span>
                    </div>
                `;
            }).join('');

            logContainer.innerHTML = html;

            // Auto-scroll to bottom if enabled
            if (autoScrollCheckbox.checked && filteredLogs.length > 0) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        function formatTimestamp(ts) {
            if (!ts) return new Date().toLocaleTimeString();
            try {
                const date = new Date(ts);
                return date.toLocaleTimeString();
            } catch {
                return ts;
            }
        }

        function formatLogEntry(entry) {
            const timestamp = formatTimestamp(entry.timestamp || entry.time);
            const level = entry._level || 'INFO';
            const message = entry.message || entry.error || JSON.stringify(entry);
            return `[${timestamp}] [${level}] ${message}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
